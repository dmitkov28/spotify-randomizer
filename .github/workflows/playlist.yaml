name: Playlist Workflow

on:
   workflow_dispatch:

jobs:
    create-playlist:
        runs-on: ubuntu-latest
        permissions:
            id-token: write
            contents: read

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up uv
              uses: astral-sh/setup-uv@v6
              with:
                version: "0.8.15"

            - name: Configure AWS credentials via OIDC
              uses: aws-actions/configure-aws-credentials@v3
              with:
                role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
                aws-region: eu-central-1

            - name: Set up python environment
              working-directory: src
              run: uv sync

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: "1.13.1"
              
            - name: Terraform Init
              working-directory: terraform
              run: terraform init -backend-config=backend.conf

            - name: Terraform Apply
              env:
                SPOTIFY_API_KEY: ${{ secrets.SPOTIFY_API_KEY }}
                SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
                SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
              working-directory: terraform
              run: terraform apply -auto-approve -var="spotify_api_key=${{secrets.SPOTIFY_API_KEY}}"

    

      